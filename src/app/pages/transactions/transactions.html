<div class="container mt-4">
  <div class="row g-4">

    <div class="col-lg-4">
      <div class="neo-card sticky-top" style="top: 20px;">
        
        <h5 class="mb-4 fw-bold text-center">
          @if (isEditing()) { ‚úèÔ∏è Editando } @else { ‚ûï Nuevo Movimiento }
        </h5>

        <form (ngSubmit)="saveTransaction()">
          
          <div class="mb-4 d-flex gap-2">
            <input type="radio" class="btn-check" name="type" id="typeInc" value="INGRESO" [(ngModel)]="formData().type">
            <label class="btn flex-fill" [class.btn-success]="formData().type === 'INGRESO'" [class.btn-outline-secondary]="formData().type !== 'INGRESO'" for="typeInc">Ingreso</label>

            <input type="radio" class="btn-check" name="type" id="typeExp" value="GASTO" [(ngModel)]="formData().type">
            <label class="btn flex-fill" [class.btn-danger]="formData().type === 'GASTO'" [class.btn-outline-secondary]="formData().type !== 'GASTO'" for="typeExp">Gasto</label>
          </div>

          <div class="neo-form-group">
            <input required type="text" class="neo-input" [(ngModel)]="formData().description" name="desc">
            <label class="label">Descripci√≥n</label>
          </div>

          <div class="row">
            <div class="col-6">
              <div class="neo-form-group">
                <input required type="number" class="neo-input" [(ngModel)]="formData().amount" name="amount" min="0.01" step="0.01">
                <label class="label">Monto (‚Ç¨)</label>
              </div>
            </div>
            <div class="col-6">
              <div class="neo-form-group">
                <input required type="date" class="neo-input" [(ngModel)]="formData().date" name="date">
                <label class="label">Fecha</label>
              </div>
            </div>
          </div>

          <div class="mb-3 mt-2">
            <label class="small text-muted ms-2 mb-1">Cuenta</label>
            <select class="neo-input w-100" [(ngModel)]="formData().accountId" name="acc" required>
              @for (acc of accounts(); track acc.id) {
                <option [value]="acc.id" class="text-dark">
                  {{ acc.name }} ({{ acc.currentBalance | currency:'EUR' }})
                </option>
              }
            </select>
          </div>

          <div class="mb-4">
            <label class="small text-muted ms-2 mb-1">Categor√≠a</label>
            <select class="neo-input w-100" [(ngModel)]="formData().categoryId" name="cat">
              <option [ngValue]="null">-- Sin categor√≠a --</option>
              @for (cat of categories(); track cat.id) {
                <option [value]="cat.id" class="text-dark">{{ cat.name }}</option>
              }
            </select>
          </div>

          <div class="d-grid gap-2">
            <button type="submit" class="btn fw-bold shadow-sm" [class.btn-warning]="isEditing()" [class.btn-primary]="!isEditing()">
              {{ isEditing() ? 'Actualizar' : 'Guardar' }}
            </button>

            @if (isEditing()) {
              <button type="button" (click)="resetForm()" class="btn btn-outline-secondary">Cancelar</button>
            }
          </div>

        </form>
      </div>
    </div>

    <div class="col-lg-8">
      <div class="neo-card p-0 overflow-hidden"> <div class="p-3 d-flex justify-content-between align-items-center border-bottom border-secondary border-opacity-10">
          <h5 class="mb-0 fw-bold">
            {{ filterAccountId() ? 'üîç Filtrado por Cuenta' : 'Historial Global' }}
          </h5>
          @if (filterAccountId()) {
            <button (click)="clearFilter()" class="btn btn-sm btn-outline-primary">‚ùå Ver Todo</button>
          }
        </div>

        <div class="table-responsive">
          <table class="table table-neo align-middle mb-0">
            <thead>
              <tr>
                <th class="ps-4">Fecha</th>
                <th>Concepto</th>
                <th>Cuenta</th>
                <th class="text-end">Monto</th>
                <th class="text-end pe-4">Acciones</th>
              </tr>
            </thead>
            <tbody>
              @for (tx of filteredTransactions(); track tx.id) {
                <tr>
                  <td class="ps-4 text-muted small">{{ tx.date | date:'dd MMM' }}</td>
                  <td>
                    <div class="fw-bold">{{ tx.description }}</div>
                    @if (tx.category) {
                      <span class="badge bg-secondary bg-opacity-25 text-body border border-secondary border-opacity-10 mt-1 fw-normal">
                        {{ tx.category.name }}
                      </span>
                    }
                  </td>
                  <td><small class="text-muted">{{ tx.account.name }}</small></td>
                  <td class="text-end fw-bold" [class.text-success]="tx.type === 'INGRESO'" [class.text-danger]="tx.type === 'GASTO'">
                    {{ tx.type === 'GASTO' ? '-' : '+' }} {{ tx.amount | currency:'EUR' }}
                  </td>
                  <td class="text-end pe-4">
                    <button class="btn btn-sm btn-link text-decoration-none" (click)="editTransaction(tx)">‚úèÔ∏è</button>
                    <button class="btn btn-sm btn-link text-danger text-decoration-none" (click)="deleteTransaction(tx.id!)">üóëÔ∏è</button>
                  </td>
                </tr>
              } @empty {
                <tr><td colspan="5" class="text-center py-5 text-muted">No hay movimientos.</td></tr>
              }
            </tbody>
          </table>
        </div>

      </div>
    </div>
  </div>
</div>